;************************************************************************************
;										    *
;   Filename:	    SUBROUTINES.asm						    *
;   Date:	    October 4, 2024						    *
;   File Version:   2								    *
;   Author:	    Alex Wheelock						    *
;   Company:	    Idaho State University					    *
;   Description:    Contains all subroutines needed for the Servo section of Lab 8. *
;										    *
;************************************************************************************

;************************************************************************************
;										    *
;   Revision History:								    *
;										    *
;   1:	Initialize file, set up for ADC conversion and output to PORTC.		    *
;										    *	    
;   2:	Setup file to use the ADC to control a servo motor on PORTC		    *
;										    *
;************************************************************************************		
	    
SUBROUTINES_CODE CODE

LOAD_RCREG
		BANKSEL	RCREG
		MOVFW	RCREG
		MOVWF	STORED_RCREG
		
		BTFSC	NEW_BYTE,2
		GOTO	SET_NEW_BYTE2
	TEST_NEW_BYTE1
		BTFSC	NEW_BYTE,1
		GOTO	SET_ADC_REQUEST		
	TEST_HANDSHAKE_TRUE
		BTFSC	HANDSHAKE,0
		BSF	NEW_BYTE,0
		GOTO	LEAVE_LOAD
	SET_ADC_REQUEST
		BSF	ADC_REQUEST,0
		BCF	NEW_BYTE,0
		GOTO	LEAVE_LOAD
	SET_NEW_BYTE2
		BSF	NEW_BYTE,3
	LEAVE_LOAD
		RETURN
 
TEST_HANDSHAKE
		BTFSC	STORED_RCREG,7
		GOTO	LEAVE_SUB
		BTFSC	STORED_RCREG,6
		GOTO	LEAVE_SUB
		BTFSS	STORED_RCREG,5
		GOTO	LEAVE_SUB
		BTFSC	STORED_RCREG,4
		GOTO	LEAVE_SUB
		BTFSC	STORED_RCREG,3
		GOTO	LEAVE_SUB
		BTFSS	STORED_RCREG,2
		GOTO	LEAVE_SUB
		BTFSC	STORED_RCREG,1
		GOTO	LEAVE_SUB
		BTFSC	STORED_RCREG,0
		GOTO	LEAVE_SUB
		BSF	HANDSHAKE,0
		MOVLW	0x24
		MOVWF	TXREG
		RETURN
		
LEAVE_SUB
		BCF	HANDSHAKE,0
		BCF	ADC_REQUEST,0
		BCF	NEW_BYTE,0
		BCF	NEW_BYTE,1
		RETURN
		
SAVE_RCREG
		BANKSEL	RCREG
		MOVFW	RCREG
		MOVWF	CURRENT_RCREG	
		MOVLW	0x24
		MOVWF	TXREG
		BCF	NEW_BYTE,0
		BSF	NEW_BYTE,1
		RETURN

SAVE_ADC
		BANKSEL ADRESL
		MOVFW	ADRESL
		BANKSEL	ADRESH
		BTFSC	RH_FLAG,0
		GOTO	SAVE_RH
		MOVWF	CURRENT_ADC_LOW
		MOVFW	ADRESH
		MOVWF	CURRENT_ADC_HIGH
		RETURN		
SAVE_RH	    
		MOVWF	CURRENT_RH_LOW
		MOVFW	ADRESH
		MOVWF	CURRENT_RH_HIGH
		RETURN
		
TEST_ADC_REQUEST
		BANKSEL	RCREG
		BTFSC	STORED_RCREG,7
		GOTO	SELECT_RH
		BTFSC	STORED_RCREG,6
		GOTO	SELECT_RH
		BTFSS	STORED_RCREG,5
		GOTO	SELECT_RH
		BTFSC	STORED_RCREG,4
		GOTO	SELECT_RH
		BTFSS	STORED_RCREG,3
		GOTO	SELECT_RH
		BTFSS	STORED_RCREG,2
		GOTO	SELECT_RH
		BTFSC	STORED_RCREG,1
		GOTO	SELECT_RH
		BTFSS	STORED_RCREG,0
		GOTO	SELECT_RH
	
		BANKSEL	TXREG 
		MOVFW	CURRENT_ADC_HIGH
		MOVWF	TXREG
		BSF	ADCON0,4
		BCF	ADCON0,3
		BCF	NEW_BYTE,0
		BCF	NEW_BYTE,1
		BSF	NEW_BYTE,2
		BCF	RH_FLAG,0
		RETURN	
		
SELECT_RH
		BANKSEL	TXREG
		MOVFW	CURRENT_RH_HIGH
		MOVWF	TXREG
		BANKSEL	ADCON0
		BCF	ADCON0,4
		BSF	ADCON0,3
		BCF	NEW_BYTE,0
		BCF	NEW_BYTE,1
		BSF	NEW_BYTE,2
		BSF	RH_FLAG,0
		RETURN
		
SECOND_ADC_BYTE		
		BTFSC	RH_FLAG,0
		GOTO	SECOND_RH_BYTE
		MOVFW	CURRENT_ADC_LOW
		MOVWF	TXREG
		BSF	PORTC,1
		GOTO	LEAVE_ADC_REQUEST
	SECOND_RH_BYTE
		MOVFW	CURRENT_RH_LOW
		MOVWF	TXREG
		
	LEAVE_ADC_REQUEST
		BCF	HANDSHAKE,0
		BCF	NEW_BYTE,0
		BCF	NEW_BYTE,1
		BCF	NEW_BYTE,2
		BCF	NEW_BYTE,3
		BCF	ADC_REQUEST,0
		
		BANKSEL	ADCON0
		BSF	ADCON0,1
		RETURN
		
NEW_CYCLE		
		BANKSEL	PORTA
		BSF	PW_TRUE,0
		BSF	PORTA,1
		MOVLW	0xC8
		MOVWF	PERIOD
		MOVFW	CURRENT_RCREG
		MOVWF	PW_COUNT
		GOTO	GOBACK